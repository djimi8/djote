<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚖️ مساعد طلبة الحقوق الذكي</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
            animation: slide 20s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-50px) translateY(-50px); }
            100% { transform: translateX(50px) translateY(50px); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 200px;
        }

        .tab:hover {
            background: #e9ecef;
            color: #007bff;
        }

        .tab.active {
            background: white;
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px auto;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.4);
        }

        .generate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .result-container {
            display: none;
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .result-container.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .result-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .action-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        #result {
            padding: 30px;
            background: white;
            max-height: 600px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }



        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #f5c6cb;
        }

        .error h4 {
            margin-bottom: 10px;
        }

        .highlight-box {
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .highlight-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 40px 30px;
            background: #f8f9fa;
        }

        .feature {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .feature h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .feature p {
            color: #6c757d;
            line-height: 1.6;
        }

        .api-key-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .api-key-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .api-key-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            transition: border-color 0.3s ease;
        }

        .api-key-section input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
        }

        .api-key-section button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .api-key-section button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .api-key-section button:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab {
                min-width: 150px;
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚖️ مساعد طلبة الحقوق الذكي</h1>
            <p>نظام شامل لمساعدة طلبة الحقوق في الدراسة والبحث والتحضير</p>
            <div style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px; position: relative; z-index: 1;">
                <div style="display: flex; align-items: center; gap: 10px; color: #28a745; font-weight: 600;">
                    <span style="font-size: 1.2em;">✅</span>
                    <span>النظام جاهز للاستخدام - مفتاح API مفعل</span>
                </div>
                <p style="font-size: 14px; color: #6c757d; margin: 5px 0 0 0;">يمكنك الآن استخدام جميع الميزات دون الحاجة لإعداد إضافي</p>
            </div>
                <p style="font-size: 14px; color: #6c757d; margin: 5px 0 0 0;">يمكنك الآن استخدام جميع الميزات دون الحاجة لإعداد إضافي</p>
            </div>
            
            <!-- قسم إعداد مفتاح API - مخفي للأمان -->
            <div class="api-key-section" style="display: none;">
                <h4>🔑 إعداد مفتاح API للذكاء الاصطناعي</h4>
                <p style="font-size: 14px; color: #6c757d;">للحصول على مفتاح مجاني من Google AI Studio: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #007bff;">اضغط هنا</a></p>
                <p style="font-size: 12px; color: #28a745; margin: 5px 0;">💡 نصيحة: بعد نسخ المفتاح من Google، استخدم زر 📋 أو Ctrl+V للصق</p>
                <p style="font-size: 11px; color: #6c757d; margin: 5px 0;">🔍 للتشخيص: استخدم زر "فحص الحالة" للتأكد من حفظ المفتاح</p>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px; position: relative;">
                        <input type="text" id="api-key" placeholder="اكتب أو الصق مفتاح API هنا..." style="width: 100% !important; padding: 12px 80px 12px 12px !important; box-sizing: border-box !important; border: 1px solid #ddd !important; border-radius: 5px !important; font-size: 14px !important; outline: none !important; margin: 0 !important;" />
                        <button onclick="pasteApiKey()" style="position: absolute; right: 40px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 14px; color: #007bff; z-index: 10;" title="لصق من الحافظة">📋</button>
                        <button onclick="togglePasswordVisibility()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; z-index: 10;" title="إظهار/إخفاء المفتاح">👁️</button>
                    </div>
                    <button onclick="saveApiKey()" style="white-space: nowrap;">💾 حفظ المفتاح</button>
                    <button onclick="testApiKey()" style="white-space: nowrap; background: #28a745;">🔍 اختبار</button>
                    <button onclick="checkApiKeyStatus()" style="white-space: nowrap; background: #17a2b8;">ℹ️ فحص الحالة</button>
                    <button onclick="clearApiKey()" style="white-space: nowrap; background: #dc3545;">🗑️ حذف</button>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">المفتاح يُحفظ محلياً في متصفحك فقط ولا يُرسل لأي خادم</p>
                <div id="api-status" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
                <div id="debug-info" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 11px; color: #6c757d; display: none;">
                    <strong>معلومات التشخيص:</strong>
                    <div id="debug-content"></div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('research')">📚 كتابة بحث قانوني</button>
            <button class="tab" onclick="switchTab('summary')">📝 تلخيص الدروس</button>
            <button class="tab" onclick="switchTab('preparation')">📋 تحضير البحث</button>
        </div>

        <div id="research-tab" class="tab-content active">
            <div class="form-row">
                <div class="form-group">
                    <label>عنوان البحث</label>
                    <input type="text" id="research-title" placeholder="مثال: مفهوم القانون وخصائصه">
                </div>
                <div class="form-group">
                    <label>مجال البحث</label>
                    <select id="research-field">
                        <option value="">اختر فرع القانون</option>
                        <option value="قانون مدني">القانون المدني</option>
                        <option value="قانون جنائي">القانون الجنائي</option>
                        <option value="قانون إداري">القانون الإداري</option>
                        <option value="قانون تجاري">القانون التجاري</option>
                        <option value="قانون دستوري">القانون الدستوري</option>
                        <option value="قانون دولي">القانون الدولي</option>
                        <option value="قانون عمل">قانون العمل</option>
                        <option value="قانون أسرة">قانون الأسرة</option>
                        <option value="قانون مالي">القانون المالي</option>
                        <option value="قانون عقاري">القانون العقاري</option>
                        <option value="قانون بحري">القانون البحري</option>
                        <option value="قانون جوي">القانون الجوي</option>
                        <option value="قانون بيئة">قانون البيئة</option>
                        <option value="قانون معلوماتية">قانون المعلوماتية</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>المستوى الأكاديمي</label>
                    <select id="research-level">
                        <option value="سنة-أولى">السنة الأولى حقوق</option>
                        <option value="سنة-ثانية">السنة الثانية حقوق</option>
                        <option value="سنة-ثالثة">السنة الثالثة حقوق</option>
                        <option value="ماستر">الماستر</option>
                        <option value="دكتوراه">الدكتوراه</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>عدد الصفحات المطلوبة</label>
                    <select id="page-count">
                        <option value="5-10">5-10 صفحات</option>
                        <option value="10-15">10-15 صفحة</option>
                        <option value="15-20">15-20 صفحة</option>
                        <option value="20-30">20-30 صفحة</option>
                        <option value="30+">أكثر من 30 صفحة</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>متطلبات إضافية (اختياري)</label>
                <textarea id="additional-requirements" placeholder="مثال: التركيز على القانون الجزائري، استخدام مراجع حديثة، تطبيق على حالات عملية..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="generate-btn" onclick="generateAcademicResearch()">
                    📝 إنشاء البحث الأكاديمي
                </button>
                <button class="generate-btn" onclick="resetForm()" style="background: #95a5a6; margin-right: 10px;">
                    🔄 إعادة تعيين
                </button>
            </div>
        </div>

        <!-- تبويب تلخيص الدروس -->
        <div id="summary-tab" class="tab-content">
            <div class="form-row">
                <div class="form-group">
                    <label>اختر المادة</label>
                    <select id="subject-select">
                        <option value="">اختر المادة</option>
                        <option value="مدخل للعلوم القانونية">مدخل للعلوم القانونية</option>
                        <option value="القانون المدني">القانون المدني</option>
                        <option value="القانون الجنائي">القانون الجنائي</option>
                        <option value="القانون الإداري">القانون الإداري</option>
                        <option value="القانون التجاري">القانون التجاري</option>
                        <option value="القانون الدستوري">القانون الدستوري</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>طول التلخيص</label>
                    <select id="summary-length">
                        <option value="قصير">قصير (صفحة واحدة)</option>
                        <option value="متوسط">متوسط (2-3 صفحات)</option>
                        <option value="مفصل">مفصل (4-5 صفحات)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>مستوى التلخيص</label>
                <select id="summary-level">
                    <option value="مبسط">مبسط (للمبتدئين)</option>
                    <option value="متوسط">متوسط (للطلاب)</option>
                    <option value="متقدم">متقدم (للامتحانات)</option>
                </select>
            </div>
            <div class="form-group">
                <label>محتوى الدرس أو الموضوع</label>
                <textarea id="lesson-content" placeholder="الصق هنا محتوى الدرس الذي تريد تلخيصه أو اكتب اسم الموضوع المطلوب تلخيصه..."></textarea>
            </div>
            <button class="generate-btn" onclick="generateSummary()">
                📝 إنشاء التلخيص
            </button>
        </div>

        <!-- تبويب تحضير البحث -->
        <div id="preparation-tab" class="tab-content">
            <div class="form-row">
                <div class="form-group">
                    <label>عنوان البحث</label>
                    <input type="text" id="prep-title" placeholder="مثال: النظام القانوني للعقود">
                </div>
                <div class="form-group">
                    <label>مجال البحث</label>
                    <select id="prep-field">
                        <option value="">اختر المجال</option>
                        <option value="قانون مدني">القانون المدني</option>
                        <option value="قانون جنائي">القانون الجنائي</option>
                        <option value="قانون إداري">القانون الإداري</option>
                        <option value="قانون تجاري">القانون التجاري</option>
                        <option value="قانون دستوري">القانون الدستوري</option>
                        <option value="قانون دولي">القانون الدولي</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>نوع التحضير</label>
                    <select id="prep-type">
                        <option value="خطة">خطة البحث فقط</option>
                        <option value="مراجع">قائمة المراجع</option>
                        <option value="أسئلة">الأسئلة المحتملة</option>
                        <option value="شامل">تحضير شامل</option>
                    </select>
                </div>
            </div>
            <button class="generate-btn" onclick="generatePreparation()">
                📋 إنشاء التحضير
            </button>
        </div>

        <div id="result-container" class="result-container">
            <div class="result-header">
                <h3>نتيجة البحث</h3>
                <div class="action-buttons">
                    <button class="action-btn copy-btn" onclick="copyResult()">📋 نسخ</button>
                    <button class="action-btn download-btn" onclick="downloadResult()">📥 تحميل</button>
                    <button class="action-btn print-btn" onclick="printResult()">🖨️ طباعة</button>
                </div>
            </div>
            <div id="result"></div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">🎯</div>
                <h4>بحث متخصص</h4>
                <p>يتم إنشاء البحث حسب المجال الأكاديمي المحدد</p>
            </div>
            <div class="feature">
                <div class="feature-icon">📚</div>
                <h4>مراجع أكاديمية</h4>
                <p>يتضمن مراجع قانونية موثوقة ومناسبة للمستوى</p>
            </div>
            <div class="feature">
                <div class="feature-icon">⚖️</div>
                <h4>صياغة قانونية دقيقة</h4>
                <p>استخدام المصطلحات القانونية الصحيحة</p>
            </div>
            <div class="feature">
                <div class="feature-icon">📝</div>
                <h4>تنسيق أكاديمي</h4>
                <p>تنسيق مناسب للأبحاث الجامعية والرسائل العلمية</p>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'research';
        let backupApiKey = null; // نسخة احتياطية من المفتاح في حالة فشل localStorage

        // متغير لحفظ المفتاح - مضمن للأمان
        let apiKeyGlobal = 'AIzaSyAr2FfARE_lCHpk3aZr4qCOyKQOgCrcZgA';

        // حفظ مفتاح API
        function saveApiKey() {
            const apiKeyInput = document.getElementById('api-key');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('⚠️ الرجاء إدخال مفتاح API');
                return;
            }
            
            // حفظ المفتاح في المتغير العام
            apiKeyGlobal = apiKey;
            console.log('API key saved in global variable:', apiKeyGlobal ? 'SUCCESS' : 'FAILED');
            
            // محاولة حفظ في localStorage
            try {
                localStorage.setItem('gemini_api_key', apiKey);
                console.log('✅ API key saved in localStorage');
            } catch (error) {
                console.warn('localStorage not available:', error);
            }
            
            // اختبار فوري للتأكد من الحفظ
            const testKey = getApiKey();
            console.log('Immediate test after save:', testKey ? 'SUCCESS' : 'FAILED');
            
            // تحديث الواجهة
            apiKeyInput.value = '';
            apiKeyInput.placeholder = 'تم حفظ المفتاح ✅';
            apiKeyInput.style.borderColor = '#28a745';
            
            alert('✅ تم حفظ مفتاح API بنجاح!');
            console.log('✅ API key saved successfully');
        }

        // الحصول على مفتاح API
        function getApiKey() {
            // إرجاع المفتاح المضمن في الكود
            return apiKeyGlobal;
        }

        // اختبار مفتاح API
        async function testApiKey() {
            const apiKey = getApiKey();
            
            if (!apiKey) {
                alert('❌ لا يوجد مفتاح محفوظ للاختبار');
                return;
            }
            
            alert('⏳ جاري اختبار مفتاح API...');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'قل مرحبا'
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10
                        }
                    })
                });
                
                if (response.ok) {
                    alert('✅ مفتاح API يعمل بشكل صحيح!');
                } else {
                    alert('❌ خطأ في مفتاح API - تحقق من صحة المفتاح');
                }
                
            } catch (error) {
                alert('❌ خطأ في الاتصال: ' + error.message);
            }
        }

        // حذف مفتاح API
        function clearApiKey() {
            if (confirm('هل تريد حذف مفتاح API المحفوظ؟')) {
                // حذف من المتغير العام
                apiKeyGlobal = null;
                
                // حذف من localStorage
                try {
                    localStorage.removeItem('gemini_api_key');
                } catch (e) {
                    console.warn('Could not remove from localStorage:', e);
                }
                
                // تحديث الواجهة
                const apiKeyInput = document.getElementById('api-key');
                apiKeyInput.placeholder = 'اكتب أو الصق مفتاح API هنا...';
                apiKeyInput.style.borderColor = '#e9ecef';
                
                alert('🗑️ تم حذف المفتاح بنجاح');
            }
        }

        // فحص حالة مفتاح API
        function checkApiKeyStatus() {
            console.log('=== API Key Status Check ===');
            console.log('apiKeyGlobal:', apiKeyGlobal ? 'EXISTS' : 'NULL');
            console.log('localStorage:', localStorage.getItem('gemini_api_key') ? 'EXISTS' : 'NULL');
            
            const apiKey = getApiKey();
            
            if (!apiKey) {
                alert('❌ لا يوجد مفتاح محفوظ\n\nحالة التشخيص:\n- متغير عام: ' + (apiKeyGlobal ? 'موجود' : 'فارغ') + '\n- localStorage: ' + (localStorage.getItem('gemini_api_key') ? 'موجود' : 'فارغ'));
                return;
            }
            
            let message = `✅ يوجد مفتاح محفوظ\n`;
            message += `الطول: ${apiKey.length} حرف\n`;
            message += `البداية: ${apiKey.substring(0, 10)}...\n`;
            message += `النهاية: ...${apiKey.substring(apiKey.length - 5)}`;
            
            if (apiKey.startsWith('AIza')) {
                message += '\n\n✅ تنسيق المفتاح صحيح';
            } else {
                message += '\n\n⚠️ تنسيق المفتاح قد يكون خاطئ';
            }
            
            alert(message);
        }

        // إظهار حالة API
        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('api-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = message;
            
            switch(type) {
                case 'success':
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    break;
                case 'error':
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    break;
                case 'warning':
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    break;
                case 'info':
                    statusDiv.style.background = '#d1ecf1';
                    statusDiv.style.color = '#0c5460';
                    break;
            }
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // عرض معلومات التشخيص
        function showDebugInfo(info) {
            const debugDiv = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            debugContent.innerHTML = `
                <br>• حالة المفتاح: ${info.hasKey ? 'موجود' : 'غير موجود'}
                <br>• طول المفتاح: ${info.keyLength || 'غير محدد'}
                <br>• بداية المفتاح: ${info.keyStart || 'غير محدد'}
                <br>• حالة الاتصال: ${info.connectionStatus || 'غير محدد'}
                <br>• آخر خطأ: ${info.lastError || 'لا يوجد'}
            `;
            
            debugDiv.style.display = 'block';
            
            setTimeout(() => {
                debugDiv.style.display = 'none';
            }, 10000);
        }

        // إظهار/إخفاء المفتاح
        function togglePasswordVisibility() {
            const apiKeyInput = document.getElementById('api-key');
            const toggleButton = event.target;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleButton.textContent = '🙈';
                toggleButton.title = 'إخفاء المفتاح';
            } else {
                apiKeyInput.type = 'password';
                toggleButton.textContent = '👁️';
                toggleButton.title = 'إظهار المفتاح';
            }
        }

        // لصق المفتاح من الحافظة
        async function pasteApiKey() {
            try {
                const text = await navigator.clipboard.readText();
                const apiKeyInput = document.getElementById('api-key');
                apiKeyInput.value = text.trim();
                
                if (text.trim()) {
                    alert('✅ تم لصق المفتاح بنجاح! لا تنس حفظه');
                    // تركيز على الحقل لإظهار المحتوى
                    apiKeyInput.focus();
                } else {
                    alert('⚠️ الحافظة فارغة');
                }
            } catch (err) {
                console.error('خطأ في اللصق:', err);
                alert('❌ لم يتم السماح بالوصول للحافظة. استخدم Ctrl+V للصق');
            }
        }



        // عند تحميل الصفحة
        window.onload = function() {
            console.log('Page loaded');
            console.log('API key ready: ' + (apiKeyGlobal ? 'YES' : 'NO'));
            
            // تهيئة معالجات الأحداث
            initializeEventHandlers();
        }

        // تهيئة معالجات الأحداث
        function initializeEventHandlers() {
            const apiKeyInput = document.getElementById('api-key');
            
            // السماح بالصق باستخدام Ctrl+V
            apiKeyInput.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'v') {
                    setTimeout(() => {
                        if (this.value.trim()) {
                            showApiStatus('تم لصق المفتاح بنجاح! لا تنس حفظه 💾', 'success');
                        }
                    }, 100);
                }
            });

            // السماح بالصق باستخدام الزر الأيمن
            apiKeyInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    if (this.value.trim()) {
                        showApiStatus('تم لصق المفتاح بنجاح! لا تنس حفظه 💾', 'success');
                    }
                }, 100);
            });

            // عرض نصائح عند التركيز على الحقل
            apiKeyInput.addEventListener('focus', function() {
                if (!this.value.trim()) {
                    showApiStatus('💡 يمكنك لصق المفتاح باستخدام زر 📋 أو Ctrl+V', 'info');
                }
            });

            // إخفاء الرسائل عند الكتابة
            apiKeyInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    const statusDiv = document.getElementById('api-status');
                    statusDiv.style.display = 'none';
                }
            });
        }

        function switchTab(tabName) {
            // إخفاء جميع التبويبات
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // إخفاء جميع أزرار التبويبات
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // إظهار التبويب المحدد
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // إخفاء النتائج عند تغيير التبويب
            document.getElementById('result-container').classList.remove('show');
        }

        function createAcademicPrompt(title, field, level, pageCount, additionalReq) {
            return `
أنت خبير أكاديمي متخصص في القانون، أريد منك كتابة بحث قانوني شامل ومفصل بالمواصفات التالية:

**عنوان البحث:** ${title}
**مجال التخصص:** ${field}
**المستوى الأكاديمي:** ${level}
**عدد الصفحات:** ${pageCount}
**متطلبات إضافية:** ${additionalReq || 'لا توجد'}

تعليمات مهمة لضمان جودة البحث:

1. **الهيكل الأكاديمي:**
   - اتبع التسلسل الهرمي: مبحث → مطلب → فرع
   - رقم كل عنصر بوضوح
   - استخدم العناوين الواضحة والمحددة

2. **المحتوى العلمي:**
   - اكتب مقدمة شاملة تتضمن الإشكالية وأهمية الموضوع
   - استخدم التعريفات الدقيقة للمصطلحات
   - اذكر آراء متنوعة للفقهاء والباحثين
   - قدم أمثلة عملية وتطبيقية
   - اربط بين النظرية والتطبيق

3. **المراجع والهوامش:**
   - اكتب هوامش مرقمة في نهاية كل فقرة مهمة
   - استخدم تنسيق المراجع الأكاديمي
   - أضف قائمة مراجع شاملة في النهاية

4. **مستوى المحتوى حسب المستوى الأكاديمي ${level}:**
   ${level === 'سنة-أولى' ? '- استخدم لغة واضحة ومبسطة\n- ركز على المفاهيم الأساسية\n- أضف شروحات إضافية للمصطلحات' : 
     level === 'سنة-ثانية' ? '- استخدم مصطلحات قانونية متوسطة\n- اربط بين النظرية والتطبيق\n- أضف أمثلة عملية' :
     level === 'سنة-ثالثة' ? '- استخدم مصطلحات قانونية متقدمة\n- قم بتحليل معمق للقضايا\n- اذكر آراء الفقه والقضاء' :
     level === 'ماستر' ? '- مستوى متقدم ودقيق\n- تحليل نقدي للآراء\n- مقارنة بين القوانين المختلفة\n- استخدام مراجع متخصصة' :
     '- مستوى بحثي عالي\n- تحليل نقدي عميق\n- إضافة جديدة للمعرفة القانونية\n- مراجع حديثة ومتخصصة'}

5. **التنسيق:**
   - استخدم العناوين الرئيسية والفرعية
   - اجعل النص مقسماً إلى فقرات منطقية
   - اكتب خاتمة تلخص النتائج والتوصيات

اكتب البحث بطريقة أكاديمية محترفة ومناسبة للمستوى المطلوب.
            `;
        }

        async function callGeminiAPI(prompt) {
            const apiKey = getApiKey();
            console.log('Calling Gemini API, key exists:', !!apiKey);
            if (!apiKey || apiKey.trim() === '') {
                throw new Error('🔑 الرجاء إدخال مفتاح API أولاً من القسم أعلى الصفحة.\n\nإذا كنت قد أدخلته بالفعل، جرب:\n1. إعادة تحميل الصفحة\n2. إعادة إدخال المفتاح\n3. التأكد من عدم وجود مسافات إضافية');
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    let errorMessage = 'خطأ غير معروف';
                    console.error('API Error Details:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData
                    });
                    
                    if (response.status === 400) {
                        if (errorData.error?.message?.includes('API key')) {
                            errorMessage = 'مفتاح API غير صحيح أو غير مفعل';
                        } else {
                            errorMessage = 'طلب غير صالح - تحقق من مفتاح API';
                        }
                    } else if (response.status === 403) {
                        errorMessage = 'مفتاح API غير مفعل أو ليس لديك صلاحية لاستخدام Gemini';
                    } else if (response.status === 429) {
                        errorMessage = 'تم تجاوز حد الاستخدام، حاول مرة أخرى لاحقاً';
                    } else if (response.status === 500) {
                        errorMessage = 'خطأ في الخادم، حاول مرة أخرى';
                    }
                    
                    throw new Error(`❌ ${errorMessage} (${response.status})\n${errorData.error?.message || ''}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('⚠️ لم يتم الحصول على استجابة صالحة من API');
                }

                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('🌐 خطأ في الاتصال بالإنترنت، تأكد من اتصالك');
                }
                throw error;
            }
        }

        async function generateAcademicResearch() {
            console.log('Starting research generation...');
            
            // فحص حالة المفتاح أولاً
            const apiKey = getApiKey();
            
            console.log('API Key check:', {
                apiKeyGlobal: apiKeyGlobal ? 'EXISTS' : 'NULL',
                localStorage: localStorage.getItem('gemini_api_key') ? 'EXISTS' : 'NULL',
                finalKey: apiKey ? 'EXISTS' : 'NULL'
            });
            
            if (!apiKey) {
                alert('❌ لم يتم العثور على مفتاح API!\n\nيرجى إدخال المفتاح في الحقل أعلاه وحفظه أولاً.');
                return;
            }
            
            const title = document.getElementById('research-title').value;
            const field = document.getElementById('research-field').value;
            const level = document.getElementById('research-level').value;
            const pageCount = document.getElementById('page-count').value;
            const additionalReq = document.getElementById('additional-requirements').value;

            if (!title.trim()) {
                alert('الرجاء إدخال عنوان البحث');
                return;
            }

            if (!field) {
                alert('الرجاء اختيار مجال البحث');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = document.querySelector('.generate-btn');

            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري إنشاء البحث الأكاديمي...</div>
                    <div style="font-size: 14px; margin-top: 10px;">قد تستغرق هذه العملية عدة دقائق</div>
                </div>
            `;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري الإنشاء...';

            try {
                const prompt = createAcademicPrompt(title, field, level, pageCount, additionalReq);
                const result = await callGeminiAPI(prompt);
                
                const formattedResult = formatAcademicResult(result, level);
                resultDiv.innerHTML = formattedResult;
                
            } catch (error) {
                console.error('خطأ في إنشاء البحث:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء إنشاء البحث</h4>
                        <p>${error.message}</p>
                        <p>تأكد من صحة مفتاح API وحاول مرة أخرى.</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '📝 إنشاء البحث الأكاديمي';
            }
        }

        function formatAcademicResult(text, level) {
            const levelNames = {
                'سنة-أولى': 'السنة الأولى حقوق',
                'سنة-ثانية': 'السنة الثانية حقوق', 
                'سنة-ثالثة': 'السنة الثالثة حقوق',
                'ماستر': 'الماستر',
                'دكتوراه': 'الدكتوراه'
            };
            
            return `
                <div class="highlight-box">
                    <h4>🎓 بحث قانوني أكاديمي - ${levelNames[level]}</h4>
                    <p>تم إنشاء البحث بنجاح وفقاً للمعايير الأكاديمية المطلوبة</p>
                </div>
                <div style="text-align: justify; line-height: 1.8; font-family: 'Times New Roman', serif;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        function createSummaryPrompt(subject, length, level, content) {
            return `
أنت أستاذ متخصص في ${subject}. أريد منك إنشاء تلخيص شامل ومفيد بالمواصفات التالية:

**المادة:** ${subject}
**طول التلخيص:** ${length}
**مستوى التلخيص:** ${level}
**المحتوى المراد تلخيصه:** ${content}

**تعليمات التلخيص:**

1. **التنظيم:**
   - اقسم التلخيص إلى عناوين رئيسية وفرعية
   - استخدم النقاط والقوائم لتسهيل القراءة
   - رقم العناصر المهمة

2. **المحتوى:**
   - استخرج النقاط الأساسية والمفاهيم المهمة
   - اذكر التعريفات الضرورية
   - أضف أمثلة توضيحية عند الحاجة
   - اربط بين المفاهيم المختلفة

**مستوى التلخيص ${level}:**
${level === 'مبسط' ? '- استخدم لغة بسيطة وواضحة\n- تجنب المصطلحات المعقدة\n- أضف شروحات إضافية' : 
  level === 'متوسط' ? '- استخدم المصطلحات القانونية المناسبة\n- تفصيل متوازن\n- ربط بين المفاهيم' : 
  '- استخدم مصطلحات قانونية دقيقة\n- تحليل عميق\n- مناسب للامتحانات والمسابقات'}

اكتب التلخيص بطريقة منسقة وسهلة الفهم.
            `;
        }

        async function generateSummary() {
            const subject = document.getElementById('subject-select').value;
            const length = document.getElementById('summary-length').value;
            const level = document.getElementById('summary-level').value;
            const content = document.getElementById('lesson-content').value;

            if (!subject) {
                alert('الرجاء اختيار المادة');
                return;
            }

            if (!content.trim()) {
                alert('الرجاء إدخال محتوى الدرس المراد تلخيصه');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;

            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري إنشاء التلخيص...</div>
                </div>
            `;

            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري الإنشاء...';

            try {
                const prompt = createSummaryPrompt(subject, length, level, content);
                const result = await callGeminiAPI(prompt);

                const formattedResult = formatSummaryResult(result, subject, length);
                resultDiv.innerHTML = formattedResult;

            } catch (error) {
                console.error('خطأ في إنشاء التلخيص:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء إنشاء التلخيص</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '📝 إنشاء التلخيص';
            }
        }

        function formatSummaryResult(text, subject, length) {
            const lengthNames = {
                'قصير': 'تلخيص قصير',
                'متوسط': 'تلخيص متوسط',
                'مفصل': 'تلخيص مفصل'
            };
            
            return `
                <div class="highlight-box">
                    <h4>📚 ${lengthNames[length]} - ${subject}</h4>
                    <p>تم إنشاء التلخيص بنجاح - مراجعة شاملة للموضوع</p>
                </div>
                <div style="text-align: justify; line-height: 1.8; font-family: 'Times New Roman', serif;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        function createPreparationPrompt(title, field, prepType) {
            let specificInstructions = '';
            
            switch(prepType) {
                case 'خطة':
                    specificInstructions = `
**اكتب خطة بحث مفصلة تتضمن:**
1. مقدمة عامة عن الموضوع
2. إشكالية البحث والأسئلة الرئيسية
3. أهمية الموضوع وأهدافه
4. المنهجية المتبعة
5. التقسيم المقترح (مباحث، مطالب، فروع)
6. المراجع الأساسية المقترحة
7. الخطة الزمنية للإنجاز
                    `;
                    break;
                case 'مراجع':
                    specificInstructions = `
**اكتب قائمة مراجع شاملة تتضمن:**
1. الكتب الأساسية في الموضوع
2. المراجع المتخصصة
3. الأطروحات والرسائل الجامعية
4. المقالات العلمية
5. النصوص القانونية ذات الصلة
6. الاجتهادات القضائية المهمة
7. المراجع الإلكترونية المفيدة
                    `;
                    break;
                case 'أسئلة':
                    specificInstructions = `
**اكتب مجموعة من الأسئلة المحتملة:**
1. أسئلة حول المفاهيم الأساسية
2. أسئلة تحليلية معمقة
3. أسئلة مقارنة
4. أسئلة تطبيقية (حالات عملية)
5. أسئلة نقدية
6. أسئلة الامتحانات المحتملة
7. أسئلة البحث المتقدمة
                    `;
                    break;
                case 'شامل':
                    specificInstructions = `
**اكتب تحضيراً شاملاً يتضمن:**
1. خطة البحث المفصلة
2. قائمة المراجع الأساسية
3. الأسئلة المحتملة
4. ملخص للنقاط الرئيسية
5. المفاهيم والتعريفات المهمة
6. الخطوات العملية للبحث
7. نصائح ومقترحات للكتابة
                    `;
                    break;
            }

            return `
أنت خبير أكاديمي في ${field}. أريد منك إعداد تحضير للبحث التالي:

**عنوان البحث:** ${title}
**المجال:** ${field}
**نوع التحضير:** ${prepType}

${specificInstructions}

**متطلبات عامة:**
- اكتب بطريقة أكاديمية منظمة
- استخدم المصطلحات القانونية الدقيقة
- قدم معلومات مفيدة وعملية
- رتب المعلومات بطريقة منطقية
- أضف نصائح مفيدة للباحث

اكتب التحضير بطريقة شاملة ومفيدة.
            `;
        }

        async function generatePreparation() {
            const title = document.getElementById('prep-title').value;
            const field = document.getElementById('prep-field').value;
            const prepType = document.getElementById('prep-type').value;

            if (!title.trim()) {
                alert('الرجاء إدخال عنوان البحث');
                return;
            }

            if (!field) {
                alert('الرجاء اختيار مجال البحث');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;

            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري إنشاء التحضير...</div>
                </div>
            `;

            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري الإنشاء...';

            try {
                const prompt = createPreparationPrompt(title, field, prepType);
                const result = await callGeminiAPI(prompt);

                const formattedResult = formatPreparationResult(result, prepType);
                resultDiv.innerHTML = formattedResult;

            } catch (error) {
                console.error('خطأ في إنشاء التحضير:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء إنشاء التحضير</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '📋 إنشاء التحضير';
            }
        }

        function formatPreparationResult(text, prepType) {
            const title = prepType === 'خطة' ? '📋 خطة البحث' : 
                         prepType === 'مراجع' ? '📚 قائمة المراجع' :
                         prepType === 'أسئلة' ? '❓ الأسئلة المحتملة' : '📋 التحضير الشامل';
            
            return `
                <div class="highlight-box">
                    <h4>${title}</h4>
                    <p>تم إعداد التحضير بنجاح - مراجعة شاملة للموضوع</p>
                </div>
                <div style="text-align: justify; line-height: 1.8; font-family: 'Times New Roman', serif;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        function resetForm() {
            // إعادة تعيين نموذج البحث الأكاديمي
            document.getElementById('research-title').value = '';
            document.getElementById('research-field').value = '';
            document.getElementById('research-level').value = '';
            document.getElementById('page-count').value = '';
            document.getElementById('additional-requirements').value = '';
            
            // إعادة تعيين نموذج التلخيص
            document.getElementById('subject-select').value = '';
            document.getElementById('summary-length').value = '';
            document.getElementById('summary-level').value = '';
            document.getElementById('lesson-content').value = '';
            
            // إعادة تعيين نموذج التحضير
            document.getElementById('prep-title').value = '';
            document.getElementById('prep-field').value = '';
            document.getElementById('prep-type').value = 'خطة';
        }

        function copyResult() {
            const resultText = document.getElementById('result').innerText;
            navigator.clipboard.writeText(resultText).then(() => {
                alert('تم نسخ النتيجة بنجاح!');
            }).catch(err => {
                console.error('خطأ في النسخ: ', err);
                alert('حدث خطأ أثناء النسخ');
            });
        }

        function downloadResult() {
            const resultText = document.getElementById('result').innerText;
            const title = document.getElementById('research-title').value || 'البحث';
            
            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${title}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printResult() {
            const resultContent = document.getElementById('result').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>طباعة البحث</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; direction: rtl; }
                        .highlight-box { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    ${resultContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>