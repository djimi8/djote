<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد الأبحاث الأكاديمية الذكي</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            margin: 0;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            border-radius: 10px 10px 0 0;
            margin-left: 2px;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group textarea {
            height: 120px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            display: block;
            margin: 30px auto;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        
        .generate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-container {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
            display: none;
        }
        
        .result-container.show {
            display: block;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .result-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5em;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .copy-btn {
            background: #17a2b8;
            color: white;
        }
        
        .copy-btn:hover {
            background: #138496;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .print-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .print-btn:hover {
            background: #e0a800;
        }
        
        #result {
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #3498db;
            font-size: 18px;
        }
        
        .loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .feature {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .feature h4 {
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .feature p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* أنماط إضافية للمميزات الجديدة */
        .audio-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .audio-controls button {
            margin: 5px;
            flex: 1;
            min-width: 120px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .quiz-timer {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .quiz-question {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .quiz-question h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .quiz-options {
            margin: 15px 0;
        }
        
        .quiz-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quiz-option:hover {
            background: #e9ecef;
        }
        
        .quiz-option input {
            margin-left: 10px;
            transform: scale(1.2);
        }
        
        .quiz-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .quiz-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .quiz-result.fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .legal-template {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .legal-template h4 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .legal-template ul {
            margin: 10px 0;
            padding-right: 20px;
        }
        
        .legal-template li {
            margin: 8px 0;
            color: #6c757d;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .highlight-box h4 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            flex: 0 0 auto;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            border-radius: 10px 10px 0 0;
            margin-left: 2px;
            white-space: nowrap;
            min-width: 140px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-left: 0;
                margin-bottom: 2px;
                min-width: auto;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .audio-controls {
                flex-direction: column;
            }
            
            .audio-controls button {
                min-width: auto;
            }
            
            .quiz-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .quiz-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚖️ مساعد طلبة الحقوق الذكي</h1>
            <p>نظام شامل لمساعدة طلبة الحقوق في الدراسة والبحث والتحضير</p>
            
            <!-- خيار اختيار النموذج -->
            <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                <label style="font-weight: bold; color: #495057; margin-bottom: 5px; display: block;">🤖 اختيار نموذج الذكاء الاصطناعي:</label>
                <select id="ai-model-select" style="width: 300px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: white;">
                    <option value="gemini-2.0-flash">⚡ Gemini 2.0 Flash (الأسرع - مجاني)</option>
                    <option value="gemini-1.5-flash">🔥 Gemini 1.5 Flash (متوازن - مجاني)</option>
                    <option value="deepseek-chat" disabled>🧠 DeepSeek Chat (قريباً)</option>
                    <option value="deepseek-coder" disabled>💻 DeepSeek Coder (قريباً)</option>
                </select>
                <small style="color: #6c757d; display: block; margin-top: 5px;">كل نموذج له نقاط قوة مختلفة في كتابة الأبحاث القانونية</small>
            </div>
            
            <div style="margin-top: 10px;">
                <button onclick="resetSystem()" style="background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                    🔧 إعادة تعيين النظام
                </button>
                <button onclick="checkSystemStatus()" style="background: #3498db; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-left: 10px;">
                    📊 حالة النظام
                </button>
                <button onclick="showModelInfo()" style="background: #17a2b8; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-left: 10px;">
                    ℹ️ معلومات النماذج
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('research')">📚 كتابة بحث قانوني</button>
            <button class="tab" onclick="switchTab('summary')">📝 تلخيص الدروس</button>
            <button class="tab" onclick="switchTab('preparation')">📋 تحضير البحث</button>
        </div>

        <div id="research-tab" class="tab-content active">
            <div class="form-row">
                <div class="form-group">
                    <label>عنوان البحث</label>
                    <input type="text" id="research-title" placeholder="مثال: مفهوم القانون وخصائصه">
                </div>
                <div class="form-group">
                    <label>مجال البحث</label>
                    <select id="research-field">
                        <option value="">اختر فرع القانون</option>
                        <option value="قانون مدني">القانون المدني</option>
                        <option value="قانون جنائي">القانون الجنائي</option>
                        <option value="قانون إداري">القانون الإداري</option>
                        <option value="قانون تجاري">القانون التجاري</option>
                        <option value="قانون دستوري">القانون الدستوري</option>
                        <option value="قانون دولي">القانون الدولي</option>
                        <option value="قانون عمل">قانون العمل</option>
                        <option value="قانون أسرة">قانون الأسرة</option>
                        <option value="قانون مالي">القانون المالي</option>
                        <option value="قانون عقاري">القانون العقاري</option>
                        <option value="قانون بحري">القانون البحري</option>
                        <option value="قانون جوي">القانون الجوي</option>
                        <option value="قانون بيئة">قانون البيئة</option>
                        <option value="قانون معلوماتية">قانون المعلوماتية</option>
                        <option value="قانون ضريبي">القانون الضريبي</option>
                        <option value="قانون تأمين">قانون التأمين</option>
                        <option value="قانون إجراءات مدنية">قانون الإجراءات المدنية</option>
                        <option value="قانون إجراءات جزائية">قانون الإجراءات الجزائية</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>المستوى الأكاديمي</label>
                    <select id="research-level">
                        <option value="سنة-أولى">السنة الأولى حقوق</option>
                        <option value="سنة-ثانية">السنة الثانية حقوق</option>
                        <option value="سنة-ثالثة">السنة الثالثة حقوق</option>
                        <option value="ماستر">الماستر</option>
                        <option value="دكتوراه">الدكتوراه</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>عدد الصفحات المطلوب</label>
                    <select id="page-count">
                        <option value="قصير">قصير (5-8 صفحات)</option>
                        <option value="متوسط">متوسط (10-15 صفحة)</option>
                        <option value="طويل">طويل (20-25 صفحة)</option>
                        <option value="مفصل">مفصل (30+ صفحة)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>متطلبات إضافية (اختياري)</label>
                <textarea id="additional-requirements" placeholder="مثال: التركيز على القانون الجزائري، استخدام مراجع حديثة، تطبيق على حالات عملية..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="generate-btn" onclick="generateAcademicResearch()">
                    📝 إنشاء البحث الأكاديمي
                </button>
                <button class="generate-btn" onclick="resetForm()" style="background: #95a5a6; margin-right: 10px;">
                    🔄 إعادة تعيين
                </button>
            </div>
        </div>

        <!-- تبويب تلخيص الدروس -->
        <div id="summary-tab" class="tab-content">
            <div class="form-group">
                <label>اختر المادة القانونية</label>
                <select id="subject-select">
                    <option value="">اختر المادة</option>
                    <option value="مدخل للعلوم القانونية">مدخل للعلوم القانونية</option>
                    <option value="القانون المدني">القانون المدني</option>
                    <option value="القانون الجنائي">القانون الجنائي</option>
                    <option value="القانون الإداري">القانون الإداري</option>
                    <option value="القانون التجاري">القانون التجاري</option>
                    <option value="القانون الدستوري">القانون الدستوري</option>
                    <option value="قانون الأسرة">قانون الأسرة</option>
                    <option value="قانون العمل">قانون العمل</option>
                </select>
            </div>
            <div class="form-group">
                <label>الدرس أو المحاضرة المراد تلخيصها</label>
                <textarea id="lesson-content" placeholder="الصق هنا محتوى الدرس أو المحاضرة التي تريد تلخيصها..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>نوع التلخيص</label>
                    <select id="summary-type">
                        <option value="شامل">تلخيص شامل</option>
                        <option value="نقاط">النقاط الرئيسية فقط</option>
                        <option value="تعريفات">التعريفات والمفاهيم</option>
                        <option value="أمثلة">الأمثلة والتطبيقات</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>مستوى التلخيص</label>
                    <select id="summary-level">
                        <option value="مبسط">مبسط للمبتدئين</option>
                        <option value="متوسط">متوسط</option>
                        <option value="متقدم">متقدم للامتحانات</option>
                    </select>
                </div>
            </div>
            <button class="generate-btn" onclick="generateSummary()">
                📝 إنشاء التلخيص
            </button>
        </div>

        <!-- تبويب تحضير البحث -->
        <div id="preparation-tab" class="tab-content">
            <div class="form-group">
                <label>عنوان البحث المراد التحضير له</label>
                <input type="text" id="prep-title" placeholder="مثال: العقد في القانون المدني الجزائري">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>فرع القانون</label>
                    <select id="prep-field">
                        <option value="">اختر الفرع</option>
                        <option value="قانون مدني">القانون المدني</option>
                        <option value="قانون جنائي">القانون الجنائي</option>
                        <option value="قانون إداري">القانون الإداري</option>
                        <option value="قانون تجاري">القانون التجاري</option>
                        <option value="قانون دستوري">القانون الدستوري</option>
                        <option value="قانون عمل">قانون العمل</option>
                        <option value="قانون أسرة">قانون الأسرة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوع التحضير</label>
                    <select id="prep-type">
                        <option value="خطة">خطة البحث فقط</option>
                        <option value="مراجع">قائمة المراجع</option>
                        <option value="أسئلة">الأسئلة المحتملة</option>
                        <option value="شامل">تحضير شامل</option>
                    </select>
                </div>
            </div>
            <button class="generate-btn" onclick="generatePreparation()">
                📋 إنشاء التحضير
            </button>
        </div>





        <div id="result-container" class="result-container">
            <div class="result-header">
                <h3>نتيجة البحث</h3>
                <div class="action-buttons">
                    <button class="action-btn copy-btn" onclick="copyResult()">📋 نسخ</button>
                    <button class="action-btn download-btn" onclick="downloadResult()">📥 تحميل</button>
                    <button class="action-btn print-btn" onclick="printResult()">🖨️ طباعة</button>
                </div>
            </div>
            <div id="result"></div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">🎯</div>
                <h4>بحث متخصص</h4>
                <p>يتم إنشاء البحث حسب المجال الأكاديمي المحدد</p>
            </div>
            <div class="feature">
                <div class="feature-icon">📖</div>
                <h4>مراجع موثوقة</h4>
                <p>استخدام مصادر علمية ومراجع أكاديمية معتمدة</p>
            </div>
            <div class="feature">
                <div class="feature-icon">⚡</div>
                <h4>إنتاج سريع</h4>
                <p>إنشاء بحث شامل في دقائق معدودة</p>
            </div>
            <div class="feature">
                <div class="feature-icon">✨</div>
                <h4>جودة عالية</h4>
                <p>محتوى أكاديمي احترافي ومنسق</p>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'research';

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // إخفاء النتائج وإعادة تعيين الحالة عند تغيير التبويب
            const resultContainer = document.getElementById('result-container');
            if (resultContainer) {
                resultContainer.classList.remove('show');
            }
            
            // إعادة تعيين حالة الاختبار والقراءة
            resetAppState();
        }
        
        // دالة لإعادة تعيين حالة التطبيق
        function resetAppState() {
            // إيقاف القراءة إن كانت تعمل
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
            }
            
            // إيقاف مؤقت الاختبار
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            // إعادة تعيين الاختبار
            currentQuiz = null;
            const quizContainer = document.getElementById('quiz-container');
            if (quizContainer) {
                quizContainer.style.display = 'none';
            }
            
            // إخفاء شريط تقدم القراءة
            const readingProgress = document.getElementById('reading-progress');
            if (readingProgress) {
                readingProgress.style.display = 'none';
            }
            
            // إعادة تعيين مؤقت الاختبار
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = '00:00';
            }
        }

        async function generateAcademicResearch() {
            const title = document.getElementById('research-title').value;
            const field = document.getElementById('research-field').value;
            const level = document.getElementById('research-level').value;
            const pageCount = document.getElementById('page-count').value;
            const additionalReq = document.getElementById('additional-requirements').value;
            
            if (!title.trim()) {
                alert('الرجاء إدخال عنوان البحث');
                return;
            }
            
            if (!field) {
                alert('الرجاء اختيار مجال البحث');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;
            
            // Show loading
            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري إنشاء البحث الأكاديمي...</div>
                    <div style="font-size: 14px; margin-top: 10px;">قد تستغرق هذه العملية عدة دقائق</div>
                </div>
            `;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري الإنشاء...';

            try {
                const prompt = createAcademicPrompt(title, field, level, pageCount, additionalReq);
                
                // الحصول على النموذج المحدد
                let selectedModel = document.getElementById('ai-model-select').value;
                
                // تحويل DeepSeek إلى Gemini مؤقتاً
                if (selectedModel.includes('deepseek')) {
                    selectedModel = 'gemini-2.0-flash';
                    document.getElementById('ai-model-select').value = selectedModel;
                    alert('⚠️ نماذج DeepSeek غير متوفرة حالياً. تم التبديل إلى Gemini 2.0 Flash.');
                }
                
                const response = await fetch('http://localhost:3000/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        type: 'academic',
                        selectedModel: selectedModel
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                resultDiv.innerHTML = formatAcademicResult(data.research);
                
            } catch (error) {
                console.error('خطأ في إنشاء البحث:', error);
                
                let errorHTML = '';
                try {
                    const errorData = JSON.parse(error.message);
                    errorHTML = `
                        <div class="error">
                            <h4>⚠️ ${errorData.type || 'خطأ في إنشاء البحث'}</h4>
                            <p><strong>المشكلة:</strong> ${errorData.message}</p>
                            ${errorData.suggestion ? `<p><strong>الحل المقترح:</strong> ${errorData.suggestion}</p>` : ''}
                            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                                <h5>💡 نصائح للحل:</h5>
                                <ul style="text-align: right; margin: 10px 0;">
                                    <li>تأكد من اتصالك بالإنترنت</li>
                                    <li>تحقق من صحة عنوان البحث</li>
                                    <li>اختر فرع القانون المناسب</li>
                                    <li>حاول مرة أخرى بعد دقيقة</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } catch (parseError) {
                    errorHTML = `
                        <div class="error">
                            <h4>⚠️ حدث خطأ أثناء إنشاء البحث</h4>
                            <p><strong>تفاصيل الخطأ:</strong> ${error.message}</p>
                            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                                <h5>💡 حلول مقترحة:</h5>
                                <ul style="text-align: right; margin: 10px 0;">
                                    <li>🔄 أعد تحميل الصفحة وحاول مرة أخرى</li>
                                    <li>⏰ انتظر دقيقة قبل المحاولة مرة أخرى</li>
                                    <li>📝 تأكد من كتابة عنوان البحث بوضوح</li>
                                    <li>🎯 اختر فرع القانون المناسب</li>
                                    <li>💾 احفظ عملك قبل المحاولة مرة أخرى</li>
                                </ul>
                                <div style="margin-top: 10px; padding: 8px; background: #d1ecf1; border-radius: 4px;">
                                    <small><strong>ملاحظة:</strong> إذا استمر الخطأ، فقد يكون هناك ضغط على الخادم. الرجاء المحاولة بعد 5 دقائق.</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = errorHTML;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '📝 إنشاء البحث الأكاديمي';
            }
        }
        
        // دالة لإعادة تعيين النموذج
        function resetForm() {
            // إعادة تعيين نموذج البحث الأكاديمي
            document.getElementById('research-title').value = '';
            document.getElementById('research-field').value = '';
            document.getElementById('research-level').value = '';
            document.getElementById('research-length').value = '';
            document.getElementById('additional-requirements').value = '';
            
            // إعادة تعيين نموذج التلخيص
            document.getElementById('subject-select').value = '';
            document.getElementById('lesson-content').value = '';
            document.getElementById('summary-type').value = 'شامل';
            document.getElementById('summary-level').value = 'متوسط';
            
            // إعادة تعيين نموذج التحضير
            document.getElementById('prep-title').value = '';
            document.getElementById('prep-field').value = '';
            document.getElementById('prep-type').value = 'خطة';
            
            // إعادة تعيين نموذج القراءة
            document.getElementById('text-to-read').value = '';
            document.getElementById('reading-speed').value = '1';
            document.getElementById('voice-type').value = 'male';
            
            // إعادة تعيين نموذج الاختبار
            document.getElementById('quiz-subject').value = '';
            document.getElementById('quiz-difficulty').value = 'سهل';
            document.getElementById('quiz-count').value = '5';
            document.getElementById('quiz-type').value = 'اختيار متعدد';
            document.getElementById('quiz-topic').value = '';
            
            // إخفاء النتائج
            const resultContainer = document.getElementById('result-container');
            if (resultContainer) {
                resultContainer.classList.remove('show');
            }
        }
        
        // دالة إعادة تعيين النظام
        async function resetSystem() {
            try {
                const response = await fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                alert('✅ تم إعادة تعيين النظام بنجاح!\nيمكنك الآن إجراء بحوث جديدة.');
                
                // إعادة تعيين كامل للصفحة
                resetForm();
                resetAppState();
                
            } catch (error) {
                console.error('خطأ في إعادة تعيين النظام:', error);
                alert('❌ فشل في إعادة تعيين النظام. حاول إعادة تحميل الصفحة.');
            }
        }
        
        // دالة فحص حالة النظام
        async function checkSystemStatus() {
            try {
                const response = await fetch('/status');
                const status = await response.json();
                
                let keyStatsText = '';
                if (status.apiKeys && status.apiKeys.stats) {
                    keyStatsText = '\n🔑 حالة مفاتيح API:\n';
                    status.apiKeys.stats.forEach(key => {
                        const statusIcon = key.isActive ? '✅' : '❌';
                        keyStatsText += `• ${key.name} (${key.type}): ${statusIcon}\n`;
                        keyStatsText += `  - استخدام: ${key.usageCount} مرة\n`;
                        keyStatsText += `  - أخطاء: ${key.failureCount}\n`;
                        keyStatsText += `  - المفتاح: ...${key.keyEnd}\n`;
                    });
                    keyStatsText += `• المفتاح الحالي: رقم ${status.apiKeys.current}\n`;
                }
                
                const statusMessage = `
📊 حالة النظام:
• عدد الطلبات الحالي: ${status.requestCount}
• الحد الأقصى: ${status.maxRequests}
• آخر إعادة تعيين: ${status.lastReset}
• وقت التشغيل: ${status.uptime} ثانية
• استخدام الذاكرة: ${Math.round(status.memory.used / 1024 / 1024)} ميجابايت
${keyStatsText}
                `;
                
                alert(statusMessage);
                
            } catch (error) {
                console.error('خطأ في فحص الحالة:', error);
                alert('❌ فشل في فحص حالة النظام.');
            }
        }
        
        // دالة إظهار معلومات النماذج
        function showModelInfo() {
            const modelInfo = `
🤖 معلومات نماذج الذكاء الاصطناعي المجانية:

⚡ Gemini 2.0 Flash (مجاني):
• الأحدث والأسرع من Google
• متخصص في المحتوى الأكاديمي
• دقة عالية في المصطلحات القانونية
• مناسب للأبحاث القصيرة والمتوسطة
• حد 1500 طلب/يوم

🔥 Gemini 1.5 Flash (مجاني):
• متوازن بين السرعة والجودة
• أداء ممتاز في التحليل القانوني
• يدعم المراجع والهوامش بدقة
• مناسب لجميع أنواع الأبحاث
• حد 1500 طلب/يوم

🧠 DeepSeek Chat (مجاني):
• نموذج متقدم للنصوص المعقدة
• ممتاز في التحليل المعمق
• دقة عالية في الصياغة الأكاديمية
• مناسب للأبحاث الطويلة والمعقدة
• استخدام مجاني بدون حدود

💻 DeepSeek Coder (مجاني):
• متخصص في النصوص التقنية
• دقة عالية في التنسيق والهيكلة
• ممتاز للأبحاث المنظمة
• مناسب للمراجع والجداول

💡 نصائح الاختيار:
• للسرعة: Gemini 2.0 Flash
• للتوازن: Gemini 1.5 Flash  
• للدقة العالية: DeepSeek Chat
• للتنسيق المتقن: DeepSeek Coder

🎉 جميع النماذج مجانية 100%!
            `;
            
            alert(modelInfo);
        }

        async function performSimpleResearch() {
            const query = document.getElementById('simple-query').value;
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;
            
            if (!query.trim()) {
                alert('الرجاء إدخال سؤال البحث');
                return;
            }
            
            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري البحث...</div>
                </div>
            `;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري البحث...';

            try {
                const response = await fetch('http://localhost:3000/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: query })
                });
                
                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                resultDiv.innerHTML = formatSimpleResult(data.research);
                
            } catch (error) {
                console.error('خطأ في البحث:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء البحث</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '🔍 إجراء البحث';
            }
        }

        // متغيرات عامة للمميزات الجديدة
        let currentSpeech = null;
        let quizTimer = null;
        let quizStartTime = 0;
        let currentQuiz = null;

        function createAcademicPrompt(title, field, level, pageCount, additionalReq) {
            return `
أنت خبير قانوني متخصص في كتابة الأبحاث القانونية للطلبة الجامعيين. أريد منك كتابة بحث قانوني شامل ومفصل بالمواصفات التالية:

**عنوان البحث:** ${title}
**فرع القانون:** ${field}
**المستوى الأكاديمي:** ${level}
**الطول المطلوب:** ${pageCount}
**متطلبات إضافية:** ${additionalReq || 'لا توجد'}

**يجب أن يتبع البحث النموذج القانوني التالي بدقة:**

**📋 الهيكل الإجباري للبحث القانوني:**

1. **صفحة العنوان:**
   - عنوان البحث
   - اسم الطالب: [اسم الطالب]
   - الأستاذ المشرف: [اسم الأستاذ]
   - الجامعة: [اسم الجامعة]
   - كلية الحقوق والعلوم السياسية
   - السنة الجامعية: 2024-2025

2. **الفهرس (جدول المحتويات):**
   - ترقيم دقيق لجميع العناوين والصفحات

3. **المقدمة:**
   - تمهيد للموضوع
   - إشكالية البحث (سؤال رئيسي)
   - أهمية الموضوع
   - أهداف البحث
   - منهجية البحث (وصفي تحليلي مقارن)
   - خطة البحث

4. **المباحث الرئيسية (2-3 مباحث):**
   - المبحث الأول: [عنوان يتعلق بالمفاهيم والتعريفات]
     - المطلب الأول: [تعريف المفهوم الأساسي]
       - الفرع الأول: [التعريف اللغوي والاصطلاحي]
       - الفرع الثاني: [التعريف الفقهي والقضائي]
     - المطلب الثاني: [خصائص أو أركان أو شروط]
       - الفرع الأول: [الخصائص الأساسية]
       - الفرع الثاني: [الخصائص الثانوية]

   - المبحث الثاني: [الأحكام والتطبيقات]
     - المطلب الأول: [الأحكام العامة]
       - الفرع الأول: [في التشريع]
       - الفرع الثاني: [في الفقه والقضاء]
     - المطلب الثاني: [التطبيقات العملية]
       - الفرع الأول: [في القانون الجزائري]
       - الفرع الثاني: [في القوانين المقارنة]

5. **الخاتمة:**
   - تلخيص أهم النتائج
   - التوصيات والاقتراحات
   - آفاق البحث المستقبلية

6. **قائمة المراجع والمصادر:**
   - الكتب (عربية وأجنبية)
   - الرسائل الجامعية
   - المقالات العلمية
   - النصوص القانونية
   - الأحكام القضائية
   - المواقع الإلكترونية

**⚖️ المتطلبات القانونية الخاصة:**

1. **المصطلحات القانونية:**
   - استخدم المصطلحات القانونية الدقيقة
   - عرّف كل مصطلح عند ذكره لأول مرة
   - استخدم المصطلحات باللغة العربية والفرنسية عند الضرورة

2. **المراجع القانونية:**
   - اذكر النصوص القانونية بدقة (رقم المادة، القانون، تاريخ الإصدار)
   - أشر للأحكام القضائية (المحكمة، رقم القرار، التاريخ)
   - استخدم مراجع قانونية موثوقة ومحدثة

3. **الأسلوب القانوني:**
   - استخدم التعبيرات القانونية المناسبة
   - تجنب الآراء الشخصية
   - اعتمد على الأدلة القانونية والفقهية
   - استخدم أسلوب التحليل والمقارنة

4. **الهوامش القانونية:**
   - رقم الهوامش بتسلسل
   - اكتب المرجع كاملاً في الهامش الأول
   - استخدم اختصارات للمراجع المتكررة

**🎯 مثال على المراجع القانونية:**
(1) د. عبد الرزاق السنهوري، الوسيط في شرح القانون المدني، الجزء الأول، نظرية الالتزام بوجه عام، دار النهضة العربية، القاهرة، 2019، ص 45.
(2) القانون المدني الجزائري، الأمر رقم 75-58 المؤرخ في 26 سبتمبر 1975، المعدل والمتمم، الجريدة الرسمية رقم 78.
(3) قرار المحكمة العليا، الغرفة المدنية، رقم 123456، المؤرخ في 15/03/2023.

**الرجاء كتابة البحث كاملاً مع التركيز على المنهجية القانونية والأكاديمية المطلوبة لطلبة الحقوق.**
            `;
        }

        // دالة تلخيص الدروس
        async function generateSummary() {
            const subject = document.getElementById('subject-select').value;
            const content = document.getElementById('lesson-content').value;
            const summaryType = document.getElementById('summary-type').value;
            const summaryLevel = document.getElementById('summary-level').value;

            if (!subject) {
                alert('الرجاء اختيار المادة القانونية');
                return;
            }

            if (!content.trim()) {
                alert('الرجاء إدخال محتوى الدرس');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;

            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري تلخيص الدرس...</div>
                </div>
            `;

            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري التلخيص...';

            try {
                const prompt = createSummaryPrompt(subject, content, summaryType, summaryLevel);
                
                const response = await fetch('http://localhost:3000/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        type: 'summary'
                    })
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                resultDiv.innerHTML = formatSummaryResult(data.research);

            } catch (error) {
                console.error('خطأ في التلخيص:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء تلخيص الدرس</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '📝 إنشاء التلخيص';
            }
        }

        function createSummaryPrompt(subject, content, summaryType, summaryLevel) {
            return `
أنت أستاذ قانون متخصص في المادة: ${subject}

المطلوب: تلخيص المحتوى التالي بطريقة ${summaryType} ومستوى ${summaryLevel}

**المحتوى المراد تلخيصه:**
${content}

**متطلبات التلخيص:**

1. **إذا كان التلخيص شامل:**
   - اكتب تلخيصاً يغطي جميع النقاط المهمة
   - استخدم ترقيماً واضحاً
   - أضف التعريفات الأساسية

2. **إذا كان النقاط الرئيسية فقط:**
   - اكتب النقاط المهمة في شكل قائمة
   - كل نقطة في سطر منفصل
   - ركز على الأساسيات

3. **إذا كان التعريفات والمفاهيم:**
   - استخرج جميع التعريفات من النص
   - اكتب كل تعريف بوضوح
   - أضف المصطلحات القانونية

4. **إذا كان الأمثلة والتطبيقات:**
   - استخرج الأمثلة العملية
   - اشرح التطبيقات القانونية
   - أضف حالات عملية إضافية

**مستوى التلخيص ${summaryLevel}:**
${summaryLevel === 'مبسط' ? '- استخدم لغة بسيطة وواضحة\n- تجنب المصطلحات المعقدة\n- أضف شروحات إضافية' : 
  summaryLevel === 'متوسط' ? '- استخدم المصطلحات القانونية المناسبة\n- تفصيل متوازن\n- ربط بين المفاهيم' : 
  '- استخدم مصطلحات قانونية دقيقة\n- تحليل عميق\n- مناسب للامتحانات والمسابقات'}

اكتب التلخيص بطريقة منسقة وسهلة الفهم.
            `;
        }

        // دالة تحضير البحث
        async function generatePreparation() {
            const title = document.getElementById('prep-title').value;
            const field = document.getElementById('prep-field').value;
            const prepType = document.getElementById('prep-type').value;

            if (!title.trim()) {
                alert('الرجاء إدخال عنوان البحث');
                return;
            }

            if (!field) {
                alert('الرجاء اختيار فرع القانون');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;

            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري إعداد التحضير...</div>
                </div>
            `;

            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري التحضير...';

            try {
                const prompt = createPreparationPrompt(title, field, prepType);
                
                const response = await fetch('http://localhost:3000/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        type: 'preparation'
                    })
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                resultDiv.innerHTML = formatPreparationResult(data.research, prepType);

            } catch (error) {
                console.error('خطأ في التحضير:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء إعداد التحضير</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '📋 إنشاء التحضير';
            }
        }

        function createPreparationPrompt(title, field, prepType) {
            const basePrompt = `
أنت خبير قانوني متخصص في ${field}. 

عنوان البحث: "${title}"
نوع التحضير المطلوب: ${prepType}
            `;

            switch(prepType) {
                case 'خطة':
                    return basePrompt + `
المطلوب: إعداد خطة بحث مفصلة تتضمن:

1. **المقدمة:**
   - تمهيد للموضوع
   - إشكالية البحث (سؤال رئيسي واضح)
   - أهمية الموضوع
   - أهداف البحث
   - منهجية البحث
   - صعوبات البحث
   - خطة البحث

2. **المباحث المقترحة:**
   - المبحث الأول: [اقترح عنواناً مناسباً]
     - المطلب الأول: [عنوان فرعي]
       - الفرع الأول: [تفصيل]
       - الفرع الثاني: [تفصيل]
     - المطلب الثاني: [عنوان فرعي]
       - الفرع الأول: [تفصيل]
       - الفرع الثاني: [تفصيل]
   
   - المبحث الثاني: [اقترح عنواناً مناسباً]
     [نفس التقسيم]

3. **الخاتمة المقترحة:**
   - النتائج المتوقعة
   - التوصيات المحتملة

اجعل الخطة متوازنة ومنطقية ومناسبة لطلبة ${field}.
                    `;

                case 'مراجع':
                    return basePrompt + `
المطلوب: إعداد قائمة مراجع شاملة ومحدثة تتضمن:

1. **الكتب الأساسية:** (10-15 مرجع)
   - كتب عربية متخصصة
   - كتب مترجمة مهمة
   - أدرج المؤلف، العنوان، دار النشر، السنة

2. **الرسائل الجامعية:** (5-8 رسائل)
   - رسائل ماجستير ودكتوراه حديثة
   - من جامعات عربية مختلفة

3. **المقالات العلمية:** (8-12 مقال)
   - مقالات من مجلات قانونية محكمة
   - مقالات حديثة (آخر 5 سنوات)

4. **النصوص القانونية:**
   - القوانين ذات الصلة
   - المراسيم التنفيذية
   - القرارات الوزارية

5. **الأحكام القضائية:**
   - قرارات المحكمة العليا
   - قرارات مجلس الدولة
   - أحكام محاكم أخرى مهمة

6. **المواقع الإلكترونية الموثوقة:**
   - مواقع رسمية
   - مكتبات رقمية
   - مجلات إلكترونية

تأكد من أن جميع المراجع حديثة وموثوقة ومتنوعة.
                    `;

                case 'أسئلة':
                    return basePrompt + `
المطلوب: إعداد مجموعة شاملة من الأسئلة المحتملة حول الموضوع:

1. **أسئلة التعريف:** (5-7 أسئلة)
   - ما المقصود بـ...؟
   - عرف...؟
   - أذكر تعريف...؟

2. **أسئلة الشرح:** (5-7 أسئلة)
   - اشرح...؟
   - وضح...؟
   - بيّن...؟

3. **أسئلة المقارنة:** (3-5 أسئلة)
   - قارن بين... و...؟
   - ما الفرق بين... و...؟
   - ميز بين... و...؟

4. **أسئلة التحليل:** (3-5 أسئلة)
   - حلل...؟
   - ناقش...؟
   - ما رأيك في...؟

5. **أسئلة التطبيق:** (3-5 أسئلة)
   - طبق على حالة عملية...؟
   - كيف يمكن تطبيق... في...؟

6. **أسئلة الحالات العملية:** (2-3 حالات)
   - حالات قانونية للتحليل والحل

اجعل الأسئلة متدرجة الصعوبة ومناسبة لمستوى الطلبة.
                    `;

                default: // شامل
                    return basePrompt + `
المطلوب: إعداد تحضير شامل يتضمن:

1. **خطة البحث المفصلة**
2. **قائمة المراجع الأساسية**
3. **الأسئلة المحتملة**
4. **النقاط المهمة للتركيز عليها**
5. **المصطلحات الأساسية وتعريفاتها**
6. **الصعوبات المتوقعة وكيفية تجاوزها**
7. **نصائح للكتابة والبحث**

اجعل التحضير دليلاً شاملاً للطالب من البداية للنهاية.
                    `;
            }
        }

        function formatAcademicResult(text) {
            // Format the academic result with proper styling
            return `<div style="text-align: justify; font-family: 'Times New Roman', serif; line-height: 2; font-size: 16px;">${text.replace(/\n/g, '<br>')}</div>`;
        }

        function formatSimpleResult(text) {
            return `<div style="text-align: justify; line-height: 1.8;">${text.replace(/\n/g, '<br>')}</div>`;
        }

        function formatSummaryResult(text) {
            return `
                <div class="highlight-box">
                    <h4>📝 تلخيص الدرس</h4>
                    <p>تم إنشاء التلخيص بنجاح - يمكنك الآن نسخه أو طباعته</p>
                </div>
                <div style="text-align: justify; line-height: 1.8; font-family: 'Times New Roman', serif;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        function formatPreparationResult(text, prepType) {
            const title = prepType === 'خطة' ? '📋 خطة البحث' : 
                         prepType === 'مراجع' ? '📚 قائمة المراجع' :
                         prepType === 'أسئلة' ? '❓ الأسئلة المحتملة' : '📋 التحضير الشامل';
            
            return `
                <div class="highlight-box">
                    <h4>${title}</h4>
                    <p>تم إعداد التحضير بنجاح - مراجعة شاملة للموضوع</p>
                </div>
                <div style="text-align: justify; line-height: 1.8; font-family: 'Times New Roman', serif;">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        // دوال قارئ النصوص
        function startReading() {
            const text = document.getElementById('text-to-read').value;
            const speed = parseFloat(document.getElementById('reading-speed').value);
            const voiceType = document.getElementById('voice-type').value;

            if (!text.trim()) {
                alert('الرجاء إدخال النص المراد قراءته');
                return;
            }

            // إيقاف القراءة الحالية إن وجدت
            if (currentSpeech) {
                currentSpeech.cancel();
            }

            // التحقق من دعم المتصفح
            if (!('speechSynthesis' in window)) {
                alert('المتصفح لا يدعم خاصية تحويل النص إلى كلام');
                return;
            }

            // إنشاء كائن الكلام
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.rate = speed;
            currentSpeech.pitch = 1;
            currentSpeech.volume = 1;

            // اختيار الصوت
            const voices = speechSynthesis.getVoices();
            const arabicVoices = voices.filter(voice => voice.lang.includes('ar'));
            
            if (arabicVoices.length > 0) {
                currentSpeech.voice = arabicVoices[0];
            }

            // عرض شريط التقدم
            const progressDiv = document.getElementById('reading-progress');
            progressDiv.style.display = 'block';

            // أحداث القراءة
            currentSpeech.onstart = function() {
                updateReadingProgress(0);
            };

            currentSpeech.onboundary = function(event) {
                const progress = (event.charIndex / text.length) * 100;
                updateReadingProgress(progress);
            };

            currentSpeech.onend = function() {
                updateReadingProgress(100);
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            };

            currentSpeech.onerror = function(event) {
                console.error('خطأ في القراءة:', event.error);
                alert('حدث خطأ أثناء القراءة');
                progressDiv.style.display = 'none';
            };

            // بدء القراءة
            speechSynthesis.speak(currentSpeech);
        }

        function pauseReading() {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                speechSynthesis.pause();
            } else if (speechSynthesis.paused) {
                speechSynthesis.resume();
            }
        }

        function stopReading() {
            if (currentSpeech) {
                speechSynthesis.cancel();
                document.getElementById('reading-progress').style.display = 'none';
            }
        }

        function updateReadingProgress(progress) {
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            
            progressFill.style.width = progress + '%';
            progressText.textContent = `جاري القراءة... ${Math.round(progress)}%`;
        }

        // دوال الاختبارات الذكية
        async function generateQuiz() {
            const subject = document.getElementById('quiz-subject').value;
            const difficulty = document.getElementById('quiz-difficulty').value;
            const count = document.getElementById('quiz-count').value;
            const type = document.getElementById('quiz-type').value;
            const topic = document.getElementById('quiz-topic').value;

            if (!subject) {
                alert('الرجاء اختيار المادة');
                return;
            }

            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const generateBtn = event.target;

            resultContainer.classList.add('show');
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>جاري إنشاء الاختبار...</div>
                </div>
            `;

            generateBtn.disabled = true;
            generateBtn.textContent = 'جاري الإنشاء...';

            try {
                const prompt = createQuizPrompt(subject, difficulty, count, type, topic);
                
                const response = await fetch('http://localhost:3000/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        type: 'quiz'
                    })
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                currentQuiz = parseQuizData(data.research);
                displayQuiz(currentQuiz);
                startQuizTimer();

            } catch (error) {
                console.error('خطأ في إنشاء الاختبار:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>حدث خطأ أثناء إنشاء الاختبار</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '❓ إنشاء الاختبار';
            }
        }

        function createQuizPrompt(subject, difficulty, count, type, topic) {
            return `
أنت أستاذ متخصص في ${subject}. أريد منك إنشاء اختبار تفاعلي بالمواصفات التالية:

**المادة:** ${subject}
**مستوى الصعوبة:** ${difficulty}
**عدد الأسئلة:** ${count}
**نوع الأسئلة:** ${type}
**الموضوع المحدد:** ${topic || 'عام'}

**تعليمات مهمة:**

1. **صيغة الإجابة المطلوبة:**
   اكتب الاختبار بالصيغة التالية بدقة:

   QUIZ_START
   السؤال 1: [نص السؤال]
   أ) [خيار أ]
   ب) [خيار ب]
   ج) [خيار ج]
   د) [خيار د]
   الإجابة الصحيحة: [الحرف الصحيح]
   التفسير: [شرح مختصر للإجابة]
   ---
   السؤال 2: [نص السؤال]
   [نفس التنسيق]
   QUIZ_END

2. **متطلبات الأسئلة:**
   - اجعل الأسئلة متنوعة ومفيدة
   - استخدم مصطلحات قانونية دقيقة
   - اجعل الخيارات منطقية ومتقاربة
   - أضف تفسيراً مفيداً لكل إجابة

3. **مستوى الصعوبة ${difficulty}:**
   ${difficulty === 'سهل' ? '- أسئلة أساسية ومفاهيم عامة\n- مناسبة للمبتدئين' : 
     difficulty === 'متوسط' ? '- أسئلة تتطلب فهماً جيداً\n- تطبيق المفاهيم' : 
     '- أسئلة متقدمة وتحليلية\n- مناسبة للامتحانات النهائية'}

4. **نوع الأسئلة ${type}:**
   ${type === 'اختيار متعدد' ? 'جميع الأسئلة اختيار من متعدد (4 خيارات)' :
     type === 'صح وخطأ' ? 'جميع الأسئلة صح وخطأ (خيارين فقط: صح/خطأ)' :
     type === 'مقالي' ? 'أسئلة مقالية تتطلب إجابة مفصلة' :
     'مزيج من أنواع الأسئلة المختلفة'}

ابدأ الاختبار الآن:
            `;
        }

        function parseQuizData(quizText) {
            const questions = [];
            const lines = quizText.split('\n');
            let currentQuestion = null;
            let inQuiz = false;

            for (let line of lines) {
                line = line.trim();
                
                if (line === 'QUIZ_START') {
                    inQuiz = true;
                    continue;
                }
                
                if (line === 'QUIZ_END') {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    break;
                }
                
                if (!inQuiz) continue;
                
                if (line.startsWith('السؤال ') && line.includes(':')) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    currentQuestion = {
                        question: line.split(':').slice(1).join(':').trim(),
                        options: [],
                        correct: '',
                        explanation: ''
                    };
                } else if (line.match(/^[أابجدد]\)/)) {
                    if (currentQuestion) {
                        currentQuestion.options.push(line);
                    }
                } else if (line.startsWith('الإجابة الصحيحة:')) {
                    if (currentQuestion) {
                        currentQuestion.correct = line.split(':')[1].trim();
                    }
                } else if (line.startsWith('التفسير:')) {
                    if (currentQuestion) {
                        currentQuestion.explanation = line.split(':').slice(1).join(':').trim();
                    }
                } else if (line === '---') {
                    // فاصل بين الأسئلة
                    continue;
                }
            }
            
            if (currentQuestion && !questions.includes(currentQuestion)) {
                questions.push(currentQuestion);
            }
            
            return questions;
        }

        function displayQuiz(questions) {
            const quizContainer = document.getElementById('quiz-container');
            const questionsDiv = document.getElementById('quiz-questions');
            const resultDiv = document.getElementById('result');
            
            if (questions.length === 0) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>لم يتم إنشاء الاختبار بشكل صحيح</h4>
                        <p>الرجاء المحاولة مرة أخرى</p>
                    </div>
                `;
                return;
            }

            let questionsHTML = '';
            
            questions.forEach((q, index) => {
                questionsHTML += `
                    <div class="quiz-question" data-question="${index}">
                        <h4>السؤال ${index + 1}: ${q.question}</h4>
                        <div class="quiz-options">
                `;
                
                q.options.forEach((option, optIndex) => {
                    const optionLetter = option.charAt(0);
                    questionsHTML += `
                        <div class="quiz-option" onclick="selectOption(${index}, '${optionLetter}')">
                            <input type="radio" name="question_${index}" value="${optionLetter}" id="q${index}_${optIndex}">
                            <label for="q${index}_${optIndex}">${option}</label>
                        </div>
                    `;
                });
                
                questionsHTML += `
                        </div>
                    </div>
                `;
            });
            
            questionsDiv.innerHTML = questionsHTML;
            quizContainer.style.display = 'block';
            resultDiv.style.display = 'none';
        }

        function selectOption(questionIndex, optionLetter) {
            const radio = document.querySelector(`input[name="question_${questionIndex}"][value="${optionLetter}"]`);
            if (radio) {
                radio.checked = true;
            }
        }

        function startQuizTimer() {
            quizStartTime = Date.now();
            const timerElement = document.getElementById('timer');
            
            quizTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function submitQuiz() {
            if (!currentQuiz) return;
            
            clearInterval(quizTimer);
            
            let score = 0;
            let totalQuestions = currentQuiz.length;
            let results = [];
            
            currentQuiz.forEach((question, index) => {
                const selectedOption = document.querySelector(`input[name="question_${index}"]:checked`);
                const selectedValue = selectedOption ? selectedOption.value : null;
                const isCorrect = selectedValue === question.correct;
                
                if (isCorrect) score++;
                
                results.push({
                    question: question.question,
                    selected: selectedValue,
                    correct: question.correct,
                    isCorrect: isCorrect,
                    explanation: question.explanation
                });
            });
            
            displayQuizResults(score, totalQuestions, results);
        }

        function displayQuizResults(score, total, results) {
            const percentage = Math.round((score / total) * 100);
            const passed = percentage >= 60;
            
            const resultDiv = document.getElementById('result');
            const quizContainer = document.getElementById('quiz-container');
            
            let resultsHTML = `
                <div class="quiz-result ${passed ? '' : 'fail'}">
                    <h3>نتيجة الاختبار</h3>
                    <p><strong>النتيجة:</strong> ${score} من ${total} (${percentage}%)</p>
                    <p><strong>الحالة:</strong> ${passed ? '✅ نجح' : '❌ راسب'}</p>
                    <p><strong>الوقت المستغرق:</strong> ${document.getElementById('timer').textContent}</p>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>مراجعة الأسئلة:</h4>
            `;
            
            results.forEach((result, index) => {
                const statusIcon = result.isCorrect ? '✅' : '❌';
                const statusColor = result.isCorrect ? '#28a745' : '#dc3545';
                
                resultsHTML += `
                    <div style="border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 8px;">
                        <p><strong>${statusIcon} السؤال ${index + 1}:</strong> ${result.question}</p>
                        <p style="color: ${statusColor};"><strong>إجابتك:</strong> ${result.selected || 'لم تجب'}</p>
                        <p style="color: #28a745;"><strong>الإجابة الصحيحة:</strong> ${result.correct}</p>
                        ${result.explanation ? `<p style="color: #6c757d;"><strong>التفسير:</strong> ${result.explanation}</p>` : ''}
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            
            resultDiv.innerHTML = resultsHTML;
            resultDiv.style.display = 'block';
            quizContainer.style.display = 'none';
        }

        function resetQuiz() {
            if (quizTimer) {
                clearInterval(quizTimer);
            }
            
            currentQuiz = null;
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('timer').textContent = '00:00';
            
            // إعادة تعيين الحقول
            document.getElementById('quiz-subject').value = '';
            document.getElementById('quiz-difficulty').value = 'سهل';
            document.getElementById('quiz-count').value = '5';
            document.getElementById('quiz-type').value = 'اختيار متعدد';
            document.getElementById('quiz-topic').value = '';
        }

        function copyResult() {
            const resultText = document.getElementById('result').innerText;
            navigator.clipboard.writeText(resultText).then(() => {
                alert('تم نسخ النتيجة بنجاح!');
            }).catch(err => {
                console.error('خطأ في النسخ: ', err);
                alert('حدث خطأ أثناء النسخ');
            });
        }

        function downloadResult() {
            const resultText = document.getElementById('result').innerText;
            const title = document.getElementById('research-title').value || 'البحث';
            
            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${title}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printResult() {
            const resultContent = document.getElementById('result').innerHTML;
            const title = document.getElementById('research-title').value || 'البحث';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>${title}</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            line-height: 1.8; 
                            margin: 2cm; 
                            text-align: justify;
                        }
                        @page { margin: 2cm; }
                    </style>
                </head>
                <body>
                    ${resultContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>